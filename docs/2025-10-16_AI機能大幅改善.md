# 2025年10月16日 - AIアシスタント機能の大幅改善

## 何をしたか？

LINEボットを「マニュアル通りに動くbot」から「本当の意味でのAIアシスタント」に進化させました。

## どう変わったか？

### 【改善前】キーワードベースのシンプルなbot
- 「カレンダーに追加」というキーワードがないと反応しない
- 「明日ジムに行く」だけでは何もしてくれない
- 毎回決まった文章で返事をする
- 過去の会話を覚えていない
- カレンダーには追加できるが、見たり変更したりできない

### 【改善後】文脈を理解するAIアシスタント
- 「明日ジムに行く」だけで自動的にカレンダー追加してくれる
- 「本当に追加できてる？」と聞いたら過去の会話を踏まえて答えてくれる
- 自然な会話のような返事をしてくれる
- 直近10件の会話を覚えている
- カレンダーの予定を見る・検索する・変更する・削除するが全部できる

## 具体的な使い方の例

### 1. 自然な言葉でカレンダー追加
```
ユーザー: 明日16時にジムに行く
bot: かしこまりました！2025年10月17日 16:00にジムの予定を追加しました。
```
※「カレンダーに追加」と言わなくてもOK！

### 2. 曖昧な時間でも理解してくれる
```
ユーザー: 明日の朝に会議
bot: 明日の朝9時に会議の予定を追加しました。
```
- 「朝」→ 09:00
- 「午後」→ 14:00
- 「夕方」→ 17:00
- 「夜」→ 19:00

### 3. 予定を確認
```
ユーザー: 今週の予定は？
bot: 今週の予定は以下の通りです：
- 10月17日 16:00 - ジム
- 10月18日 09:00 - 会議
- 10月20日 14:00 - 買い物
```

### 4. 特定の予定を検索
```
ユーザー: ジムの予定いつだっけ？
bot: ジムの予定は10月17日 16:00です。
```

### 5. 予定を変更
```
ユーザー: ジムを17時に変更して
bot: ジムの予定を17時に変更しました。
```

### 6. 予定をキャンセル
```
ユーザー: 明日のジムキャンセルで
bot: 明日のジムの予定を削除しました。
```

### 7. 複数日の予定も追加できる
```
ユーザー: 20日から25日まで休暇
bot: 10月20日から25日まで休暇の予定を追加しました。
```

### 8. 文脈を理解した会話
```
ユーザー: 明日ジムに行く
bot: 明日16時にジムの予定を追加しました。
ユーザー: 本当に追加できてる？
bot: はい、しっかりと10月17日16時にジムの予定を追加できました！
```

## 技術的な改善内容

### 1. OpenAI Function Calling の導入
- GPT-4oを使って、ユーザーの意図を理解
- 6種類の機能（ツール）を自動で選んで実行
- キーワードマッチングから意図理解へ完全移行

### 2. 会話履歴の保存
- 新しいデータベーステーブル `conversation_history` を作成
- 直近10件の会話を保存
- ユーザーごとに会話を分けて管理

### 3. カレンダー管理機能の完全実装
新しく追加した機能：
- **予定一覧**: `list_upcoming_events` - 「今週の予定は？」
- **予定検索**: `search_calendar_event` - 「ジムの予定いつ？」
- **予定更新**: `update_calendar_event` - 「ジムを17時に変更」
- **予定削除**: `delete_calendar_event` - 「明日のジムキャンセル」

既存機能の改善：
- **予定追加**: `add_to_calendar` - 日時パースを大幅改善

### 4. 日時解析の改善
- 相対日付の計算（「明日」「来週」など）
- 曖昧な時間表現の理解（「朝」「午後」など）
- 複数日イベントの正確な処理
- Google Calendar API仕様に完全準拠

### 5. バグ修正
- カレンダーイベントが間違った日時に追加されていた問題を解決
- 時刻指定イベントが終日イベントになっていた問題を解決

## 実装したファイル

### 新規作成
1. `supabase/migrations/20251016000002_create_conversation_history.sql`
   - 会話履歴を保存するデータベーステーブル

2. `supabase/functions/manage-calendar-events/index.ts`
   - カレンダーの予定を見る・変更する・削除する機能

### 大幅更新
1. `supabase/functions/line-webhook/index.ts`
   - LINEからのメッセージを受け取る部分
   - OpenAI GPT-4oとの連携
   - 6つのツールの定義と実行

2. `supabase/functions/create-calendar-event/index.ts`
   - カレンダーに予定を追加する機能
   - 日時パース機能の大幅改善

## 使っている技術

- **AI**: OpenAI GPT-4o (Function Calling)
- **バックエンド**: Supabase Edge Functions (Deno)
- **データベース**: PostgreSQL
- **カレンダー**: Google Calendar API
- **メッセージング**: LINE Messaging API

## 今後の可能性

この仕組みを使えば、以下のような機能も追加できます：
- リマインダー機能（「30分前に通知して」）
- 習慣トラッキング（「毎週月水金にジム」）
- 天気予報との連携（「明日雨なら予定変更」）
- タスク管理（「来週までにレポート提出」）
- 健康管理（「毎日の体重記録」）

## まとめ

今回の改善で、LINEボットが「言われたことしかできないbot」から「文脈を理解して柔軟に対応できるAIアシスタント」に進化しました。自然な日本語で話しかけるだけで、カレンダーの管理が簡単にできるようになりました。

---

**開発日**: 2025年10月16日
**開発者**: Daiki Takayama
**コミットID**: c6d994c
**GitHub**: https://github.com/daikiAI01/my-growth-assistant
